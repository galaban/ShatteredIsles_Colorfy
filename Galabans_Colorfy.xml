<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, April 18, 2016, 12:02 PM -->
<!-- MuClient version 4.94 -->

<!-- Plugin "Galabans_Colorfy" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Galabans_Colorfy"
   author="Galaban"
   id="f9a04028f9a00c498017575b"
   language="Lua"
   purpose="Add COLOR to the Shattered Isles mud"
   date_written="2016-04-18 12:01:42"
   requires="4.68"
   version="1.0"
   >

</plugin>


<!--  Triggers  -->

<triggers>

  <!-- Mining / foraging -->
  <trigger
   custom_colour="7"
   enabled="y"
   match="You can't seem to find anything worth * here."
   sequence="100"
  >
  </trigger>

  <trigger
   custom_colour="15"
   enabled="y"
   match="You have found a vein of *."
   sequence="100"
  >
  </trigger>
  <trigger
   custom_colour="15"
   enabled="y"
   match="You have found some *"
   sequence="100"
  >
  </trigger>

  <!-- Crafting -->
  <trigger
   custom_colour="7"
   enabled="y"
   match="You mess up *"
   sequence="100"
  >
  </trigger>

  <!--  Colorfy Players -->
  <trigger
   enabled="y"
   expand_variables="y"
   match="Also here: *"
   omit_from_output="y"
   omit_from_log="y"
   script="colorfyInRoomMobs"
   send_to="12"
   sequence="100"
  >
  </trigger>

  <!--  Objects on the ground -->
  <trigger
   enabled="y"
   expand_variables="y"
   match="* You notice *"
   omit_from_output="y"
   omit_from_log="y"
   script="colorfyInRoomObjects"
   send_to="12"
   sequence="100"
  >
  </trigger>

  <!-- Speculation -->
  <trigger
   enabled="y"
   expand_variables="y"
   match="There looks like * to the *."
   omit_from_output="y"
   omit_from_log="y"
   send_to="12"
   sequence="100"
  >
  <send>local b_green = ANSI(1)..ANSI(32)
local b_white = ANSI(1)..ANSI(37)

local ncolor = b_green
if ("%1" == "nothing") then ncolor = b_white end
AnsiNote(b_white.."There looks like "..ncolor.."%1"..b_white.." to the %2.")
</send>
  </trigger>

  <trigger
   enabled="y"
   match="This looks like a good spot for *."
   omit_from_output="y"
   omit_from_log="y"
   send_to="12"
   sequence="100"
  >
  <send>local b_green = ANSI(1)..ANSI(32)
local b_white = ANSI(1)..ANSI(37)

local ncolor = b_green
if ("%1" == "nothing") then ncolor = b_white end
AnsiNote(b_white.."This looks like a good spot for "..ncolor.."%1"..b_white)
</send>
  </trigger>

  <!-- Equipment -->
  <trigger
   enabled="y"
   match="*Currently Equipped:"
   send_to="12"
   sequence="100"
  >
  <send>StartEqList()</send>
  </trigger>

  <trigger
   enabled="n"
   match="^\S+\s+: (.*)$"
   regexp="y"
   group="ColorfyEq"
   send_to="12"
   sequence="100"
   omit_from_output="y"
   omit_from_log="y"
   script="GrabEQItem"
  >
  </trigger>

  <trigger
   enabled="n"
   match="^$"
   regexp="y"
   group="ColorfyEq"
   send_to="12"
   sequence="100"
   script="EQNewLine"
  >
  </trigger>


  <!-- Inventory -->
  <trigger
   enabled="y"
   match="*Inventory:"
   send_to="12"
   sequence="100"
  >
  <send>StartInvList()</send>
  </trigger>

  <trigger
   enabled="n"
   match="^\s?(.*)+$"
   regexp="y"
   group="ColorfyInv"
   send_to="12"
   sequence="100"
   omit_from_output="y"
   omit_from_log="y"
   script="GrabInvItem"
  >
  </trigger>

  <trigger
   enabled="n"
   match="^$"
   regexp="y"
   group="ColorfyInv"
   send_to="12"
   sequence="100"
   script="InvNewLine"
  >
  </trigger>

  <!-- Containers (piggybacks off of inventory) -->
  <trigger
   enabled="y"
   match="Inside you see:"
   send_to="12"
   sequence="100"
  >
  <send>StartInvList()</send>
  </trigger>



</triggers>

<!--  Script  -->


<script>
<![CDATA[
-------------------------------
--  GLOBALS
-------------------------------

local b_black = ANSI(1,30)
local d_black = ANSI(0,30)
local b_red = ANSI(1,31)
local d_red = ANSI(0,31)
local b_green = ANSI(1,32)
local d_green = ANSI(22,32)
local b_yellow = ANSI(1,33)
local d_yellow = ANSI(0,33)
local b_blue = ANSI(1,34)
local d_blue = ANSI(0,34)
local b_magenta = ANSI(1,35)
local d_magenta = ANSI(0,35)
local b_cyan = ANSI(1,36)
local d_cyan = ANSI(0,36)
local b_white = ANSI(1,37)
local d_white = ANSI(0,37)


local BLACK = 1
local RED = 2
local GREEN = 3  
local YELLOW = 4 
local BLUE = 5 
local MAGENTA = 6 
local CYAN = 7 
local WHITE = 8
local DEFAULT_COLOUR = "&w"
ANSI_colours = {
    [GetNormalColour (BLACK)]   = d_black,
    [GetNormalColour (RED)]     = d_red,
    [GetNormalColour (GREEN)]   = d_green,
    [GetNormalColour (YELLOW)]  = d_yellow,
    [GetNormalColour (BLUE)]    = d_blue,
    [GetNormalColour (MAGENTA)] = d_magenta,
    [GetNormalColour (CYAN)]    = d_cyan,
    [GetNormalColour (WHITE)]   = d_white,
    [GetBoldColour   (BLACK)]   = b_black,
    [GetBoldColour   (RED)]     = b_red,
    [GetBoldColour   (GREEN)]   = b_green,
    [GetBoldColour   (YELLOW)]  = b_yellow,
    [GetBoldColour   (BLUE)]    = b_blue,
    [GetBoldColour   (MAGENTA)] = b_magenta,
    [GetBoldColour   (CYAN)]    = b_cyan,
    [GetBoldColour   (WHITE)]   = b_white
}

name_colours = {
    [GetNormalColour (BLACK)]   = "black",
    [GetNormalColour (RED)]     = "maroon",
    [GetNormalColour (GREEN)]   = "green",
    [GetNormalColour (YELLOW)]  = "olive",
    [GetNormalColour (BLUE)]    = "navy",
    [GetNormalColour (MAGENTA)] = "purple",
    [GetNormalColour (CYAN)]    = "teal",
    [GetNormalColour (WHITE)]   = "darkgray",
    [GetBoldColour   (BLACK)]   = "dimgray",
    [GetBoldColour   (RED)]     = "red",
    [GetBoldColour   (GREEN)]   = "lime",
    [GetBoldColour   (YELLOW)]  = "yellow",
    [GetBoldColour   (BLUE)]    = "blue",
    [GetBoldColour   (MAGENTA)] = "magenta",
    [GetBoldColour   (CYAN)]    = "cyan",
    [GetBoldColour   (WHITE)]   = "white",
}  -- end conversion table



-------------------------------
--  Utility Functions
-------------------------------
function get256ColorFromObject(objectString, default)
    local objString = string.lower(objectString)
    local eqcol = default

    -- First, go through all the actual colors
    if (string.find(objString," red ") ~= nil) then
        eqcol = "red"
    elseif (string.find(objString,"orange") ~= nil) then
        eqcol = "#FF8C00"
    elseif (string.find(objString,"green") ~= nil) then
        eqcol = "green"
    elseif (string.find(objString,"yellow") ~= nil) then
        eqcol = "yellow"
    elseif (string.find(objString," blue ") ~= nil) then
        eqcol = "blue"
    elseif (string.find(objString,"purple") ~= nil) then
        eqcol = "#9400D3"
    elseif (string.find(objString,"brown ") ~= nil) then
        eqcol = "#8B4513"
    elseif (string.find(objString,"black ") ~= nil) then
        eqcol = "dimgray"
    elseif (string.find(objString," white ") ~= nil) then
        eqcol = "white"
    elseif (string.find(objString," grey ") ~= nil) then
        eqcol = "darkgray"

    -- Metals
    elseif (string.find(objString,"bronze") ~= nil
         or string.find(objString,"brass") ~= nil
         or string.find(objString,"orichalcum") ~= nil) then
        eqcol = "gold"
    elseif (string.find(objString,"copper") ~= nil) then
        eqcol = "chocolate"
    elseif (string.find(objString,"gold") ~= nil) then
        eqcol = "yellow"
    elseif (string.find(objString,"cobalt") ~= nil) then
        eqcol = "#045CFF"
    elseif (string.find(objString,"lead") ~= nil) then
        eqcol = "powderblue"
    elseif (string.find(objString," steel[%s,.]") ~= nil   
         or string.find(objString,"crudesteel") ~= nil
         or string.find(objString,"arcsilver") ~= nil) then
        eqcol = "steelblue"
    elseif (string.find(objString,"persarium") ~= nil) then
        eqcol = "#FFDEAD"
    elseif (string.find(objString,"pewter") ~= nil
         or string.find(objString,"nickel") ~= nil
         or string.find(objString,"zinc") ~= nil
         or string.find(objString," tin[%s,.]") ~= nil
         or string.find(objString,"platinum") ~= nil) then
        eqcol = "silver"
    elseif (string.find(objString,"niello") ~= nil
         or string.find(objString," iron[%s,.]") ~= nil
         or string.find(objString,"blacksteel") ~= nil) then
        eqcol = "#808080"
    elseif (string.find(objString,"electrum") ~= nil) then
        eqcol = "#D0D080"

    -- Look for leather first.
    elseif (string.find(objString,"leather") ~= nil) then
        eqcol = "brown"

    -- Resources --

    -- Cloth & Hides (includes crafting materials
    elseif (string.find(objString,"hide") ~= nil
         or string.find(objString," fur[%s,.]") ~= nil) then
        eqcol = "brown"
    elseif (string.find(objString,"snakeskin") ~= nil
         or string.find(objString,"hemp") ~= nil
         or string.find(objString,"vine") ~= nil
         or string.find(objString,"herbs") ~= nil
         or string.find(objString,"scale") ~= nil) then  --scales, dragonscale
        eqcol = "green"
    elseif (string.find(objString,"wool") ~= nil
         or string.find(objString,"cotton") ~= nil
         or string.find(objString,"broadcloth") ~= nil
         or string.find(objString,"canvas") ~= nil
         or string.find(objString,"damask") ~= nil
         or string.find(objString,"feathers") ~= nil
         or string.find(objString,"cashmere") ~= nil
         or string.find(objString,"brocade") ~= nil
         or string.find(objString,"linen") ~= nil
         or string.find(objString,"twill[%s,.]") ~= nil) then
        eqcol = "#FFE4C4"
    elseif (string.find(objString,"silk") ~= nil
         or string.find(objString,"samite") ~= nil
         or string.find(objString,"velvet") ~= nil) then
        eqcol = "#B22222"
    elseif (string.find(objString,"burlap") ~= nil
         or string.find(objString,"straw") ~= nil) then
        eqcol = "#CD853F"

    -- cooking
    elseif (string.find(objString,"salt") ~= nil) then
        eqcol = "white"

    -- dark wood
    elseif (string.find(objString,"wood[%s,.]") ~= nil    -- Cherrywood, Beechwood, Redwood, Applewood, Silverwood
         or string.find(objString,"yew") ~= nil
         or string.find(objString,"teak") ~= nil
         or string.find(objString," elm[%s,.]") ~= nil
         or string.find(objString,"sycamore") ~= nil
         or string.find(objString,"mesquite") ~= nil
         or string.find(objString,"walnut") ~= nil
         or string.find(objString,"chestnut") ~= nil
         or string.find(objString,"mahogany") ~= nil
         or string.find(objString,"poplar") ~= nil
         or string.find(objString,"osage") ~= nil
         or string.find(objString,"ebony") ~= nil
         or string.find(objString," oak") ~= nil) then
        eqcol = "#894821"

    -- light wood
    elseif (string.find(objString,"birch") ~= nil
         or string.find(objString,"fir") ~= nil
         or string.find(objString,"bamboo") ~= nil
         or string.find(objString,"balsa") ~= nil
         or string.find(objString,"pine") ~= nil
         or string.find(objString,"hickory") ~= nil
         or string.find(objString,"willow") ~= nil
         or string.find(objString,"spruce") ~= nil
         or string.find(objString,"cypress") ~= nil
         or string.find(objString,"cedar") ~= nil
         or string.find(objString,"maple") ~= nil) then
        eqcol = "burlywood"

    -- Gems/precious stone
    elseif (string.find(objString,"ruby") ~= nil) then
        eqcol = "red"
    elseif (string.find(objString,"sapphire") ~= nil) then
        eqcol = "cornflowerblue"
    elseif (string.find(objString,"cmerald") ~= nil) then
        eqcol = "springgreen"
    elseif (string.find(objString," agate") ~= nil) then
        eqcol = "#FF80C0"
    elseif (string.find(objString,"diamond") ~= nil) then
        eqcol = "lightcyan"
    elseif (string.find(objString,"pearl") ~= nil) then
        eqcol = "palegoldenrod"
    elseif (string.find(objString," opal") ~= nil) then
        eqcol = "#48D1CC"
    elseif (string.find(objString,"amethyst") ~= nil) then
        eqcol = "#BA55D3"
    elseif (string.find(objString,"topaz") ~= nil) then
        eqcol = "#FF7F50"
    elseif (string.find(objString,"garnet") ~= nil) then
        eqcol = "#FA8072"
    elseif (string.find(objString,"amber") ~= nil) then
        eqcol = "#FFA500"
    elseif (string.find(objString,"onyx") ~= nil) then
        eqcol = "#696969"
    elseif (string.find(objString,"turquoise") ~= nil) then
        eqcol = "#40E0D0"
    elseif (string.find(objString,"peridot") ~= nil) then
        eqcol = "#7FFF00"
    elseif (string.find(objString,"quartz") ~= nil) then
        eqcol = "#FAFAD2"
    elseif (string.find(objString," lapis[%s,.]") ~= nil) then
        eqcol = "#4169E1"
    elseif (string.find(objString,"bloodstone") ~= nil) then
        eqcol = "red"
    elseif (string.find(objString,"moonstone") ~= nil) then
        eqcol = "#AFEEEE"
    elseif (string.find(objString,"sunstone") ~= nil) then
        eqcol = "#F4AF60"
    elseif (string.find(objString,"aquamarine") ~= nil) then
        eqcol = "#40E0D0"
    elseif (string.find(objString,"citrine") ~= nil) then
        eqcol = "#FFA500"
    elseif (string.find(objString,"jade") ~= nil) then
        eqcol = "#40FF40"

    -- Stone and Bone
    elseif (string.find(objString," bone") ~= nil
         or string.find(objString,"ivory") ~= nil
         or string.find(objString,"limestone") ~= nil
         or string.find(objString,"marble") ~= nil) then
        eqcol = "#FFE4C4"

    elseif (string.find(objString,"sand") ~= nil
         or string.find(objString,"sandstone") ~= nil
         or string.find(objString,"pumice") ~= nil
         or string.find(objString,"granite") ~= nil
         or string.find(objString,"porcelain") ~= nil) then
        eqcol = "#EEE8AA"

    elseif (string.find(objString," stone[%s,.]") ~= nil) then
        eqcol = "#808080"
    elseif (string.find(objString,"dragonbane") ~= nil) then
        eqcol = "goldenrod"

    elseif (string.find(objString," shale") ~= nil
         or string.find(objString,"basalt") ~= nil
         or string.find(objString,"soapstone") ~= nil
         or string.find(objString,"flint") ~= nil) then
        eqcol = "#696969"
    elseif (string.find(objString,"coal") ~= nil
         or string.find(objString,"obsidian") ~= nil) then
        eqcol = "dimgray"
    elseif (string.find(objString," clay[%s,.]") ~= nil) then
        eqcol = "brown"

    -- Fruit
    elseif (string.find(objString,"apples") ~= nil
         or string.find(objString,"cranberries") ~= nil
         or string.find(objString,"strawberries") ~= nil
         or string.find(objString,"tomatoes") ~= nil
         or string.find(objString,"rapsberries") ~= nil
         or string.find(objString,"cherries") ~= nil) then
        eqcol = "red"
    elseif (string.find(objString,"grapes") ~= nil
         or string.find(objString,"boysenberries") ~= nil) then
        eqcol = "#9400D3"
    elseif (string.find(objString,"blackberries") ~= nil
         or string.find(objString,"figs") ~= nil
         or string.find(objString,"plums") ~= nil
         or string.find(objString,"dates") ~= nil
         or string.find(objString,"blueberries") ~= nil) then
        eqcol = "#4B0082"
    elseif (string.find(objString,"pears") ~= nil) then
        eqcol = "#228B22"
    elseif (string.find(objString,"bananas") ~= nil) then
        eqcol = "#FFD700"
    elseif (string.find(objString,"coconuts") ~= nil
          or string.find(objString,"pineapples") ~= nil) then
        eqcol = "#B8860B"
    elseif (string.find(objString,"lemons") ~= nil) then
        eqcol = "#FFFF00"
    elseif (string.find(objString,"limes") ~= nil) then
        eqcol = "#7FFF00"
    elseif (string.find(objString,"peaches") ~= nil
         or string.find(objString,"apricots") ~= nil) then
        eqcol = "#FFA500"

    -- Vegetables
    elseif (string.find(objString,"beans") ~= nil
         or string.find(objString,"greens") ~= nil
         or string.find(objString,"okra") ~= nil
         or string.find(objString,"peas") ~= nil
         or string.find(objString,"lettuce") ~= nil
         or string.find(objString,"spinach") ~= nil
         or string.find(objString,"bell peppers") ~= nil
         or string.find(objString,"cabbage") ~= nil) then
        eqcol = "#008800"
    elseif (string.find(objString,"corn") ~= nil) then
        eqcol = "#FFFF80"
    elseif (string.find(objString,"carrots") ~= nil) then
        eqcol = "#FF8C00"
    elseif (string.find(objString,"onions") ~= nil
         or string.find(objString,"leeks") ~= nil) then
        eqcol = "#98FB98"
    elseif (string.find(objString,"hot peppers") ~= nil
         or string.find(objString,"beets") ~= nil
         or string.find(objString,"turnips") ~= nil) then
        eqcol = "red"
    elseif (string.find(objString,"olives") ~= nil) then
        eqcol = "#6B8E23"
    elseif (string.find(objString,"mushrooms") ~= nil
         or string.find(objString,"potatoes") ~= nil) then
        eqcol = "#B8860B"

    -- These are the broad categories of resources that I've left out:
    -- Meat... yeah, we'll leave that as whatever the player chose.
    -- Spices, herbs, & grain... (except "herbs")
    -- Misc. Food & Drink...
    -- Misc. Resources (vellum, paper, etc)

    end


    return eqcol
end


-------------------------------
--  Mobs (Players)
-------------------------------
function colorfyInRoomMobs(rName, rLine, rWildcards, rStyles)

    -- This only has two styles, but they are configurable, so we have to process them this way.
    local style = rStyles[1]
    local outStr = ANSI_colours[style.textcolour].."Also here: "
    local mobcolor = ANSI(1,37) -- bright white
    if (rStyles[2] ~= nil) then
        style = rStyles[2]
        mobcolor = ANSI_colours[style.textcolour]
    end
    local playercolor = b_green
    if (mobcolor == b_green) then
        playercolor = b_cyan
    end

    local str = rWildcards[1]
    local itm = ""
    local firstWord = ""
    local firstItem = true
    for v in string.gmatch(str, "[^,]+") do
        if (firstItem == true) then
            firstItem = false
        else
            outStr = outStr..", "
        end
        itm = v:match("^%s*(.-)%s*$")
        firstWord = string.lower(itm:match("^%S+"))
        if (firstWord == "and") then
            firstWord = itm:sub(string.len(firstWord)+2)
            firstWord = firstWord:match("^%S+")
        end 
        if(firstWord == "a" or firstWord == "an" or firstWord == "the") then
            outStr = outStr.. mobcolor..itm
        else
            outStr = outStr.. playercolor..itm
        end
    end

    AnsiNote(outStr)
end


-------------------------------
--  Items on the ground
-------------------------------
function colorfyInRoomObjects(rName, rLine, rWildcards, rStyles)
    local firstTime = true

    -- OK, this is, essentially, a non-function right now.
    -- What we are going to have to do is this:
    --      * Grab the color of the room
    --      * Strip off the rLine before the "You notice" line
    --      * AnsiTell that color/text
    --      * For everything after that, split on the commas
    --      * Colorfy each object and ColourTell on that

    -- Get the colors
    local style = rStyles[1]
    local roomCol = name_colours[style.textcolour] or "white"
    local defaultObjectCol = name_colours[style.textcolour] or "white"
    if (rStyles[2] ~= nil) then
        defaultObjectCol = name_colours[rStyles[2].textcolour] or "white"
    end

    local PATTERN = " You notice "
    local startRoomIndx, endRoomIndex = rLine:find(PATTERN)

    -- UGH!  I hate this, but if the room desc has a "You notice" in it, 
    -- we have to skip that one.
    local nextStart, nextIndx = string.find(rLine:sub(endRoomIndex), PATTERN)
    while nextIndx ~= nil do
        endRoomIndex = nextIndx
        startRoomIndx = nextStart
        local nextStart, nextIndx = string.find(rLine:sub(endRoomIndex), PATTERN)
    end
    
    ColourTell(roomCol,"",rLine:sub(1,startRoomIndx-1))
    ColourTell(defaultObjectCol,"",rLine:sub(startRoomIndx,endRoomIndex))

    local objectList = rLine:sub(endRoomIndex+1)

    local objectColor = defaultObjectCol
    local firstItem = true
    for objItem in objectList:gmatch("[^,]+") do
    
        if (firstItem == false) then
            ColourTell(objectColor, "", ",")
        end
        firstItem = false

        if (objItem:find("^ and ")) then
            objItem = objItem:sub(5)
            ColourTell(roomCol,""," and")
            lastitem = true
        end

        objectColor = get256ColorFromObject(objItem, defaultObjectCol)
        ColourTell(objectColor, "", objItem)
    end

    Note("") -- Terminate the line and send it to the mud..
end


-------------------------------
--  Equipment
-------------------------------
newLineCount = 0
function StartEqList()
    EnableTriggerGroup("ColorfyEq",true)
    newLineCount = 0
end

function GrabEQItem(rName, rLine, rWildcards, rStyles)
    local eqcol = b_white

    local firsthalf = rLine:match(".*:")
    local secondhalf = rLine:sub(firsthalf:len()+1)

    eqcol = get256ColorFromObject(secondhalf, "white")

    --AnsiNote(b_white..firsthalf.. eqcol..secondhalf)

    ColourNote("white","",firsthalf,
            eqcol,"",secondhalf)

end

function EQNewLine()
    newLineCount = newLineCount + 1
    if (newLineCount == 2) then
        EnableTriggerGroup("ColorfyEq",false)  
    end
end

-------------------------------
--  Inventory
-------------------------------
function StartInvList()
    EnableTriggerGroup("ColorfyInv",true)
    newLineCount = 0
end

function GrabInvItem(rName, rLine, rWildcards, rStyles)
    local eqcol = b_white

    local style = rStyles[1]
    if (style.text == " " and rStyles[2] ~= nil) then
        style = rStyles[2]
    end

    eqcol = get256ColorFromObject(rLine, name_colours[style.textcolour] or "white")

    ColourNote(eqcol,"",rLine)

end

function InvNewLine()
    newLineCount = newLineCount + 1
    if (newLineCount == 2) then
        EnableTriggerGroup("ColorfyInv",false)  
    end
end



Note("Galaban's Colorfy Plugin loaded.")

]]>
</script>


</muclient>
